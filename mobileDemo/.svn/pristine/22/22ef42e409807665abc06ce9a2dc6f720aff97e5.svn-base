<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./css/api.css">
    <link rel="stylesheet" type="text/css" href="./css/common.css">
    <link rel="stylesheet" type="text/css" href="./css/common-component.css">
    <link rel="stylesheet" type="text/css" href="./css/font-icon.css">
    <link rel="stylesheet" type="text/css" href="./css/reset.css">
    <link rel="stylesheet" type="text/css" href="./css/caicui.css">
    <title>个人中心头2</title>
    <style type="text/css">
        .header{
            /*background: #fff;*/
        }
        .header.homeheader{
            /*position: static; */
        }
        .header.homeheader > * {
            position: absolute;
            width: 100%;
            bottom:0;
        }
        .header.homeheader .header-nav{
          	/*bottom:0.1rem;*/
        }
        .header-home .message-bells {
          position: absolute;
          top: 0.2rem;
          right: 0.3rem;
          height: 1.2rem;
          width: 1rem;
          line-height: 1;
        }
        .header-home .message-bells i {
          font-size: 0.36rem;
          color: #666;
          position: absolute;
          right: 0.22rem;
          top: 0.16rem;
        }
        .header.homeheader .header-my{
        	color: #000;
        }
    </style>
</head>

<body class="homepage">
    <div class="islogin none">
        <div class="header homeheader">
            <div class="header-home">
                <div class="center">
                    <i style="background: url(image/zbg.png) no-repeat;width: 1.76rem;height: 0.56rem;background-size: 100% 100%;"></i>
                    <i style="width: 1px;height: 0.5rem;background-color: #ccc;"></i>
                    <i class="icon-caicui"></i><i class="icon-caicui-e"></i>
                </div>
                <div tapmode onclick="go_next('message-center')" class="message-bells"><i class="icon-message"></i>
                <div class="msg-mark msg-num ri_h"></div>
              </div>
            </div>
            <ul class="header-nav col-3">

                <li tapmode onclick="set_index(0)" class="active">
                    在学
                </li>
                <li tapmode onclick="set_index(1)">
                    未激活
                </li>
                <li tapmode onclick="set_index(2)">
                    已过期
                </li>
            </ul>
            <div class="header-my active">
                <div class="center">
                    个人中心
                </div>
                <div tapmode="" onclick="to_set()" class="right">
                    <i class="icon-settings icon-settings-size"></i>
                </div>
            </div>
        </div>
        <!-- 底部导航栏-->
        <ul class="footer-nav">
            <li tapmode="" onclick="openTabMe(0)">
                <i class="icon-dashboard"></i>
                <p>
                    中心
                </p>
            </li>
            <li tapmode="" onclick="openTabMe(1)">
                <i class="icon-course"></i>
                <p>
                    课程
                </p>
            </li>
            <li tapmode="" onclick="openTabMe(2)" class="active">
                <i class="icon-user"></i>
                <p>
                    我的
                </p><span class="msg-mark center_num"></span>
            </li>
        </ul>
    </div>
    <div class="nologin none">
        <div class="logo"><img src="image/logo-t.png" alt="">
        </div>
        <div class="form">
            <input type="text" placeholder="手机号／邮箱" name="username" class="input-txt">
            <input type="password" placeholder="请输入密码" name="password" class="input-txt">
            <span tapmode="" onclick="forget()" class="forget buginput">忘记密码?</span>
            <!--<div class="remberpass" tapmode onclick="rember(this)">-->
            <!--<div class="is_rember">-->
            <!--<p></p>-->
            <!--</div>-->
            <!--记住账号密码-->
            <!--</div>-->
            <div onclick="login()" tapmode="" class="btn">
                登录
            </div>
        </div>
        <div tapmode="" onclick="phone_reg()" class="phone">
            手机号注册
        </div>
        <div class="lands">
            <div tapmode="" onclick="login_qq()" class="ot login_qq">
                <i class="icon-qq"></i><span>qq</span>
            </div>
            <div tapmode="" onclick="login_weixin()" class="ot login_wx">
                <i class="icon-weixin"></i><span>微信</span>
            </div>
            <div tapmode="" onclick="login_weibo()" class="ot login_wb">
                <i class="icon-weibo"></i><span>微博</span>
            </div>
        </div>
    </div>
    <!-- 预设圆环进度条尺寸 -->
    <div style="opacity:.0001; position: absolute; top: 50%;z-index:-1">
        <div id="svgDown" class="down-progress"></div>
        <div id="svgAudio" class="audio-progress"></div>
    </div>
    <script type="text/javascript" src="./script/api.js"></script>
    <script type="text/javascript" src="./script/zepto.js"></script>
    <script type="text/javascript" src="./script/comm.js"></script>
    <script type="text/javascript" src="./script/caicui.js"></script>
    <script type="text/javascript" src="./script/db.js"></script>
    <script type="text/javascript" src="./script/saveTasksProgress.js"></script>
    <script type="text/javascript">
    //页面跳转
    window.CAICUI = {};
    var clickCount = 1;
    var timePicker;
    var y, h;

    function to_set() { //打开设置
        api.setStatusBarStyle({
            style: 'dark'
        });
        api.openWin({
            name: 'set-up',
            url: './html/set-up.html',
            delay: 200
        });
    }

    function set_index(a) { //课程切换
        $(".header-nav li").removeClass('active').eq(a).addClass('active');
        api.setFrameGroupIndex({
            name: 'course_tab',
            index: a
        });
    }

    function openTabMe(i) { //个人中心切换
        $('.header > *').removeClass('active').eq(i).addClass('active');
        $('.footer-nav li').removeClass('active').eq(i).addClass('active');
        var color;
        switch (i) {
            case 0:
                api.setStatusBarStyle({
                    style: 'dark'
                });
                color = '#fff';
                break;
            case 1:
                api.setStatusBarStyle({
                    style: 'dark'
                });
                color = '#fff';
                break;
            case 2:
                api.setStatusBarStyle({
                    style: 'dark'
                });
                color = '#fff';
                break;
        }
        $('.header').css('background', color);
        if (i == 1) {
            i = 'course'
        }
        if (i == 2) {
            i = 1;
        }
        if (i == 'course') {
            api.setFrameGroupAttr({
                name: 'ucenter_tab',
                hidden: true
            });
            api.openFrameGroup({
                name: 'course_tab',
                background: '#fff',
                rect: {
                    x: 0, //左上角x坐标
                    y: y, //左上角y坐标
                    w: api.winWidth, //宽度，若传'auto'，页面从x位置开始自动充满父页面宽度
                    h: h, //高度，若传'auto'，页面从y位置开始自动充满父页面高度
                    //							marginLeft : 0, //相对父window左外边距的距离
                    //							marginTop : 0, //相对父window上外边距的距离
                    //							marginBottom : 0, //相对父window下外边距的距离
                    //							marginRight : 0 //相对父window右外边距的距离
                },
                scrollEnabled: true,
                index: 0,
                preload: 2,
                frames: [{ //在学
                    name: 'course-studying-f',
                    url: './html/course-studying-f.html',
                    bounces: true,
                    reload: true,
                    bgColor: '#f3f3f3',
                    vScrollBarEnabled: false,
                    hScrollBarEnabled: false
                }, { //未激活
                    name: 'course-noactive-f',
                    url: './html/course-noactive-f.html',
                    bounces: true,
                    reload: true,
                    bgColor: '#f3f3f3',
                    vScrollBarEnabled: false,
                    hScrollBarEnabled: false
                }, { //已过期
                    name: 'course-overdue-f',
                    url: './html/course-overdue-f.html',
                    bounces: true,
                    bgColor: '#f3f3f3',
                    reload: true,
                    vScrollBarEnabled: false,
                    hScrollBarEnabled: false
                }]
            }, function(ret, err) {
                $(".header-nav li").removeClass('active').eq(ret.index).addClass('active');
            });
        } else {
            api.setFrameGroupAttr({
                name: 'course_tab',
                hidden: true
            });
            api.setFrameGroupAttr({
                name: 'ucenter_tab',
                hidden: false
            });
            api.setFrameGroupIndex({
                name: 'ucenter_tab',
                index: i
            });
        }
    }

    //消息
    function go_next(name) {
        var reload = true;
        if (name == 'video-buffer') {
            reload = true;
        }
        api.openWin({
            name : name,
            url : "html/" + name + '.html',
            delay : 200,
            reload : reload
        });
    }
    function openindex() {
        api.setFrameGroupAttr({
            name: 'course_tab',
            hidden: true
        });
        var header = $api.dom('.header');
        var footer = $api.dom('.footer-nav');
        $api.fixIos7Bar(header);
        var footerPos = $api.offset(footer);
        var headerPos = $api.offset(header);
        y = headerPos.h;
        h = api.winHeight - headerPos.h - footerPos.h;
        api.openFrameGroup({
            name: 'ucenter_tab',
            background: '#f3f3f3',
            rect: {
                x: 0, //左上角x坐标
                y: y, //左上角y坐标
                w: api.winWidth, //宽度，若传'auto'，页面从x位置开始自动充满父页面宽度
                h: h, //高度，若传'auto'，页面从y位置开始自动充满父页面高度
                //						marginLeft : 0, //相对父window左外边距的距离
                //						marginTop : 0, //相对父window上外边距的距离
                //						marginBottom : 0, //相对父window下外边距的距离
                //						marginRight : 0 //相对父window右外边距的距离
            },
            reload: true,
            scrollEnabled: false,
            index: 1,
            preload: 1,
            vScrollBarEnabled: false,
            hScrollBarEnabled: false,
            frames: [{ //中心
                name: 'user-index',
                url: './html/user-index.html',
                bounces: true,
                bgColor: '#f3f3f3',
                vScrollBarEnabled: false,
                hScrollBarEnabled: false
            }, { //我的
                name: 'user-mine-f',
                url: './html/user-mine-f.html',
                bounces: true,
                bgColor: '#f3f3f3',
                reload: true,
                vScrollBarEnabled: false,
                hScrollBarEnabled: false
            }]
        }, function(ret, err) {

        });
        getCCconfig(function() {}, true);
    }

    function bind_push() {
        var push = api.require('push');
        var username = get_loc_val('mine', 'nickName');
        push.bind({
            userName: username,
            userId: api.deviceId
        }, function(ret, err) {});
    }

    //去绑定
    function to_bind() {
        api.openWin({
            name: 'bind',
            url: './html/bind.html',
            delay: 200,
            slidBackEnabled: false
        });
        setTimeout(function() {
            api.setStatusBarStyle({
                style: 'light'
            });
        }, 350);
    }

    //忘记密码
    function forget() {
        api.openWin({
            name: 'findPswOne',
            url: './html/findPswOne.html',
            delay: 200,
            slidBackEnabled: false
        });
        setTimeout(function() {
            api.setStatusBarStyle({
                style: 'light'
            });
        }, 350);
    }

    //手机号注册
    function phone_reg() {
        api.openWin({
            name: 'sign-up',
            url: './html/sign-up.html',
            delay: 200,
            slidBackEnabled: false
        });
        setTimeout(function() {
            api.setStatusBarStyle({
                style: 'light'
            });
        }, 350);
    }


    $('.inputbug').click(function() {
        $(".input-txt").unbind();
    });
    //普通登录
    function login() {
        var name = $.trim($('input[name=username]').val());
        var password = $.trim($('input[name=password]').val());
        if (name == '') {
            api.toast({
                msg: '手机号／邮箱不能为空',
                location: 'middle'
            });
            //            $('input[name=username]').focus();
            return false;
        }
        if (password == '') {
            api.toast({
                msg: '密码不能为空',
                location: 'middle'
            });
            //            $('input[name=password]').focus();
            return false;
        }
        api.showProgress({
            title: '登录中',
            model: true
        });
        set_token(function(res, error) {

            if (error) {
                api.hideProgress();
                api.toast({
                    msg: error.msg,
                    location: 'middle'
                });
                return false;
            }
            if (res.state == 'success' && res.data.token) {
                var param = {};
                param.account = name;
                param.password = password;
                param.token = res.data.token;
                ajaxRequest('api/v2.1/login', 'post', param, function(ret, err) { //007.005 会员登录
                    api.hideProgress();
                    if (err) {
                        api.toast({
                            msg: err.msg,
                            location: 'middle'
                        });
                        return false;
                    }
                    if (ret.state == 'success') {
                        $api.setStorage('account', name);

                        $api.setStorage('password', password);

                        $api.setStorage('token', ret.data.token);

                        $api.setStorage('mine', ret.data);

                        if (ret.data.isAvatar == false) {
                            api.openWin({
                                name: 'sign-edit',
                                url: './html/sign-edit.html',
                                slidBackEnabled: false,
                                bgColor: '#fff',
                                delay: 200,
                                pageParam: {
                                    nickName: ret.data.nickName
                                }
                            });
                        } else {
                            to_ucenter(true);
                        }
                    } else if (ret.state == 'error') {
                        var msg = '';
                        if (err_conf_007[ret.msg]) {
                            msg = err_conf_007[ret.msg];
                            api.toast({
                                msg: msg,
                                location: 'middle'
                            });
                        }

                    }
                });
            } else {
                api.hideProgress();
                var err = '';
                if (!isEmpty(err_conf_007[res.msg])) {
                    err = err_conf_007[res.msg];
                    api.toast({
                        msg: err,
                        location: 'middle'
                    });
                }
                
            }
        });
    }

    //qq登录
    function login_qq() {
        api.showProgress({
            title: '授权中',
            model: true
        });
        //				setTimeout(function() {
        //					api.hideProgress();
        //				}, 1500);
        var obj = api.require('qq');
        obj.login(function(ret, err) {
            if (ret.openId) {
                set_token(function(res, error) {
                    if (error) {
                        api.toast({
                            msg: error.msg,
                            location: 'middle'
                        });
                        api.hideProgress();
                        return false;
                    }
                    if (res.state == 'success') {
                        var param = {};
                        param.token = res.data.token;
                        param.societyType = 'society_qq';
                        param.societyId = ret.openId;
                        $api.setStorage('token', res.data.token);
                        ajaxRequest('api/v2.1/oauthLogin', 'post', param, function(ret, err) { //007.003 auth登录
                            if (err) {
                                api.toast({
                                    msg: err.msg,
                                    location: 'middle'
                                });
                                return false;
                            }
                            if (ret && ret.state == 'success') {
                                $api.setStorage('token', ret.data.token);
                                $api.setStorage('mine', ret.data);
                                $api.setStorage('outh', {
                                    'societyType': param.societyType,
                                    'societyId': param.societyId
                                });
                                if (ret.data.isAvatar == false) {
                                    api.openWin({
                                        name: 'sign-edit',
                                        url: './html/sign-edit.html',
                                        slidBackEnabled: false,
                                        bgColor: '#fff',
                                        delay: 200,
                                        pageParam: {
                                            nickName: ret.data.nickName
                                        }
                                    });
                                } else {
                                    to_ucenter(true);
                                }
                            } else if (ret.state == 'error') {
                                if (ret.msg == '1001') {
                                    $api.setStorage('outh', {
                                        'societyType': param.societyType,
                                        'societyId': param.societyId
                                    });
                                    to_bind();
                                    return false;
                                }
                                var msg = '';
                                if (err_conf_007[ret.msg]) {
                                    msg = err_conf_007[ret.msg];
                                    api.toast({
                                        msg: msg,
                                        location: 'middle'
                                    });
                                }

                            }
                        });
                    } else {
                        var err = '';
                        if (!isEmpty(err_conf_007[res.msg])) {
                            err = err_conf_007[res.msg];
                            api.toast({
                                msg: err,
                                location: 'middle'
                            });
                        }
                        api.hideProgress();

                    }
                });
            } else {
                api.hideProgress();
            }
        });
    }

    //微信登录
    function login_weixin() {


        api.showProgress({
            title: '授权中',
            modal: true
        });
        //				setTimeout(function() {
        //					api.hideProgress();
        //				}, 1500);
        var myobj = api.require('weiXin');
        myobj.registerApp(function(ret, err) {
            if (ret.status) {
                myobj.auth(function(data, err) {
                    if (data.status) {
                        var token = data.token;
                        myobj.getUserInfo(function(msg, err) {
                            if (msg.status) {
                                set_token(function(res, error) {
                                    if (error) {
                                        api.toast({
                                            msg: error.msg,
                                            location: 'middle'
                                        });
                                        return false;
                                    }
                                    if (res.state == 'success') {
                                        var param = {};
                                        param.token = res.data.token;
                                        param.societyType = 'society_weixin';
                                        param.societyId = msg.openid;
                                        $api.setStorage('token', res.data.token);
                                        ajaxRequest('api/v2.1/oauthLogin', 'post', param, function(ret, err) { //007.003 auth登录
                                            if (err) {
                                                api.toast({
                                                    msg: err.msg,
                                                    location: 'middle'
                                                });
                                                return false;
                                            }
                                            if (ret && ret.state == 'success') {
                                                $api.setStorage('token', ret.data.token);
                                                $api.setStorage('mine', ret.data);
                                                $api.setStorage('outh', {
                                                    'societyType': param.societyType,
                                                    'societyId': param.societyId
                                                });
                                                if (ret.data.isAvatar == false) {
                                                    api.openWin({
                                                        name: 'sign-edit',
                                                        url: './html/sign-edit.html',
                                                        slidBackEnabled: false,
                                                        bgColor: '#fff',
                                                        delay: 200,
                                                        pageParam: {
                                                            nickName: ret.data.nickName
                                                        }
                                                    });
                                                } else {
                                                    to_ucenter(true);
                                                }
                                            } else if (ret.state == 'error') {
                                                if (ret.msg == '1001') {
                                                    $api.setStorage('outh', {
                                                        'societyType': param.societyType,
                                                        'societyId': param.societyId
                                                    });
                                                    to_bind();
                                                    return false;
                                                }
                                                var msg = '';
                                                if (err_conf_007[ret.msg]) {
                                                    msg = err_conf_007[ret.msg];
                                                    api.toast({
                                                        msg: msg,
                                                        location: 'middle'
                                                    });
                                                }

                                            }
                                        });
                                    } else {
                                        var err = '';
                                        if (!isEmpty(err_conf_007[res.msg])) {
                                            err = err_conf_007[res.msg];
                                            api.toast({
                                                msg: err,
                                                location: 'middle'
                                            });
                                        }

                                    }
                                });
                            } else {
                                api.hideProgress();
                            }
                        });
                    } else {
                        api.hideProgress();
                    }
                });
            } else {
                api.hideProgress();
            }
        });
    }

    //新浪登录
    function login_weibo() {
        api.showProgress({
            title: '授权中',
            modal: true
        });
        //				setTimeout(function() {
        //					api.hideProgress();
        //				}, 1500);
        var myobj = api.require('sinaWeiBo');
        myobj.auth(function(ret, err) {
            if (ret.status) {
                set_token(function(res, error) {
                    if (error) {
                        api.toast({
                            msg: error.msg,
                            location: 'middle'
                        });
                        return false;
                    }
                    if (res.state == 'success') {
                        var param = {};
                        param.token = res.data.token;
                        param.societyType = 'society_weibo';
                        param.societyId = ret.userID;
                        $api.setStorage('token', res.data.token);
                        ajaxRequest('api/v2.1/oauthLogin', 'post', param, function(ret, err) { //007.003 auth登录
                            if (err) {
                                api.toast({
                                    msg: err.msg,
                                    location: 'middle'
                                });
                                return false;
                            }
                            if (ret && ret.state == 'success') {
                                $api.setStorage('token', ret.data.token);
                                $api.setStorage('mine', ret.data);
                                $api.setStorage('outh', {
                                    'societyType': param.societyType,
                                    'societyId': param.societyId
                                });
                                if (ret.data.isAvatar == false) {
                                    api.openWin({
                                        name: 'sign-edit',
                                        url: './html/sign-edit.html',
                                        slidBackEnabled: false,
                                        bgColor: '#fff',
                                        delay: 200,
                                        pageParam: {
                                            nickName: ret.data.nickName
                                        }
                                    });
                                } else {
                                    to_ucenter(true);
                                }
                            } else if (ret.state == 'error') {
                                if (ret.msg == '1001') {
                                    $api.setStorage('outh', {
                                        'societyType': param.societyType,
                                        'societyId': param.societyId
                                    });
                                    to_bind();
                                    return false;
                                }
                                var msg = '';
                                if (err_conf_007[ret.msg]) {
                                    msg = err_conf_007[ret.msg];
                                    api.toast({
                                        msg: msg,
                                        location: 'middle'
                                    });
                                }

                            }
                        });
                    } else {
                        var err = '';
                        if (!isEmpty(err_conf_007[res.msg])) {
                            err = err_conf_007[res.msg];
                            api.toast({
                                msg: err,
                                location: 'middle'
                            });
                        }

                    }
                });
            } else {
                api.hideProgress();
            }
        });
    }

    function to_ucenter(flag) {

        var jsfun = "relogin('" + flag + "');";
        api.execScript({
            name: 'root',
            script: jsfun
        });

        api.setStatusBarStyle({
            style: 'light'
        });
        $('input').blur();
        $('.nologin').addClass('none');
        $('.islogin').removeClass('none').focus();
        api.removeLaunchView({
            animation: {
                type: 'fade',
                duration: 500
            }
        });
        openindex();
        openTabMe(0);
        bind_push();
        center_num();
        var notice = isEmpty($api.getStorage('open_notice')) ? 0 : $api.getStorage('open_notice');
        clearInterval(push_timer);
        if (notice == 1) {
            init_push();
        }


        // var user_nickname = get_loc_val('mine', 'nickName');
        // var user_token = $api.getStorage('token');
        // var user_memberId = get_loc_val('mine', 'memberId');
        // var post_param = {
        //     token: user_token,
        //     memberId: user_memberId,
        //     memberName: user_nickname,
        //     categoryId: "ff808081473905e701475cd3c2080001", //必须，证书id    ff808081473905e701475cd3c2080001
        //     categoryName: "ACCA", // 证书名称
        //     subjectId: "ff808081473905e701476254ba24007a", //必须，科目id  ff808081473905e7014762542d940078
        //     subjectName: "P2", // 科目名称
        //     courseId: "ff8080814dc1dc4e014dff874a2029e9", //必须，课程id    ff808081486933e6014889882d9c0590
        //     courseName: "复习串讲-ACCA P2 Corporate Reporting", //必须，课程名称    courseName
        //     chapterId: "ff8080814dc1dc4e014dff874a2529ea", //必须，章节id   chapterId
        //     chapterName: "串讲内容", //必须，章节名称   chapterName
        //     taskId: "ff8080814dc1dc4e014dff874a2d29ec", //必须，任务id    1
        //     taskName: "串讲-1", //任务名称
        //     progress: 1111, //必须，当前进度值，视频为秒，试卷为题数量，文档为页码   5
        //     total: 4157, //必须，任务总长度   48
        //     state: "init" //必须，进度状态默认init，完成：complate   complate       
        // };

        // ajaxRequest('api/v2.1/chapter/taskProgress', 'post', post_param, function(ret, err) {//008.024保存任务进度日志（new）tested
        //     if(err){
        //         api.toast({
        //             msg : err.msg,
        //             location : 'middle'
        //         });
        //     }
        //     //if (ret && ret.state == 'success') {
        //     //$api.setStorage(user_nickname + 'self' + courseId, '');
        //     //清除整个课程结构的课程进度
        //     //}
        // });




        saveTasksProgress.init();

    }

    function to_login() { //去登陆
        var jsfun = "cancel_login();";
        api.execScript({
            name: 'root',
            script: jsfun
        });
        api.setStatusBarStyle({
            style: 'dark'
        });
        api.setScreenOrientation({
            orientation: 'portrait_up'
        });
        $api.rmStorage('token');
        $api.rmStorage('mine');
        $api.rmStorage('center_num');
        clearInterval(push_timer);
        var password = isEmpty($api.getStorage('password')) ? '' : $.trim($api.getStorage('password'));
        var account = isEmpty($api.getStorage('account')) ? '' : $.trim($api.getStorage('account'));
        $('input[name=username]').val(account);
        $('input[name=password]').val(password);

        $('.islogin').addClass('none');
        $('.nologin').removeClass('none');

        //				var jsfun = "if(typeof(eval('closeVideo')=='function')){closeVideo();}";
        //				api.execScript({
        //					name: 'video',
        //					script: jsfun
        //				});

        api.sendEvent({
            name: 'closeVideo'
        });

        api.removeLaunchView({
            animation: {
                type: 'fade',
                duration: 500
            }
        });
        api.closeFrameGroup({
            name: 'course_tab'
        });
        api.closeFrameGroup({
            name: 'ucenter_tab'
        });

        var toCloseWin = [
            "announce-datail",
            "atydying-datile",
            "chapter-notes",
            "class-notes",
            "course-aq",
            "course-talk-top",
            "course-test",
            "message-center",
            "mine-notes",
            "modify",
            "my-notes",
            "my-question",
            "my-talk",
            "new-mine",
            "new-notes",
            "new-question",
            "new-talk",
            "notes-detial-top",
            "question-detail-head",
            "question-mine",
            "section-notes",
            "video-header",
            "vodeo_buffer",
            "course-studying-top",
            "set-up",
            "user-mine",
            "video",
            "video-menu",
            "mine-notes"
        ];
        for (var p in toCloseWin) {
            api.closeWin({
                name: toCloseWin[p]
            });
        }

        api.closeToWin({
            name: 'root'
        });
    }

    function my_init(callback) {
        if ((api.connectionType == 'none' || api.connectionType == 'unknown') && !isEmpty(getstor('memberId')) && !isEmpty($api.getStorage('token'))) {
            api.removeLaunchView({
                animation: {
                    type: 'fade',
                    duration: 500
                }
            });
            to_ucenter(true);
            return false;
        }
        var token = isEmpty($api.getStorage('token')) ? '' : $api.getStorage('token');
        if (!isEmpty(token)) {
                    
            ajaxRequest('api/v2/member/get', 'get', { //007.009  用户信息
                token: token
            }, function(ret, err) {
                if (err) {
                    api.removeLaunchView({
                        animation: {
                            type: 'fade',
                            duration: 500
                        }
                    });
                    callback(false);
                }
                if (ret && ret.state == 'success') {
                    if (ret.data.isAvatar == false) {
                        api.removeLaunchView({
                            animation: {
                                type: 'fade',
                                duration: 500
                            }
                        });
                    }
                    callback(ret.data);
                } else {
                    callback(false);
                }
            });
        } else {
            api.removeLaunchView({
                animation: {
                    type: 'fade',
                    duration: 500
                }
            });
            callback(false);
        }
    }

    //中心消息数量
    function center_num() {
        if (!isEmpty($api.getStorage('center_num'))) {
            var num = $api.getStorage('center_num');
            if (num < 1) {
                $('.center_num').html('');
            } else {
            	if(num > 99 ){
            		$('.msg-mark').html('99+');
            	}else{
            		$('.msg-mark').html(num);
            	}
//              $('.center_num').html(num);
            }
        } else {
            var param = {};
            param.typeId = '';
            param.pageNo = 1;
            param.type = 1;
            param.isRead = 0;
            param.pageSize = 1;
            param.token = $api.getStorage('token');
            ajaxRequest('api/v2/message/list', 'get', param, function(ret, err) {
                if (err) {
                    api.toast({
                        msg: err.msg,
                        location: 'middle'
                    });
                    return false;
                }
                if (ret && ret.state == 'success') {
                    var num = isEmpty(ret.totalCount) ? '0' : ret.totalCount;
                    if (num < 1) {
                        $('.msg-mark').html('');
                    } else if (num > 99) {
                        $('.msg-mark').html('99+');
                    } else {
                        $('.msg-mark').html(num);
                    }
                    $api.setStorage('center_num', num);
                } else {
                    api.toast({
                        msg: ret.msg,
                        location: 'middle'
                    });
                }
            });
        }
    }
    var reloginTimer = null;

    function cancel_login() {
        clearInterval(reloginTimer);
    }

    function DoLogin(account, password) {
        set_token(function(res, errors) {
            if (res && res.state == 'success') {
                //继续登录
                var param = {};
                param.account = account;
                param.password = password;
                param.token = res.data.token;
                myajaxRequest('api/v2.1/login', 'post', param, function(ret1, err1) { //007.005 会员登录
                    if (ret1 && ret1.state == 'success') {
                        $api.setStorage('account', account);

                        $api.setStorage('password', password);

                        $api.setStorage('token', ret1.data.token);

                        $api.setStorage('mine', ret1.data);

                        if (ret1.data.isAvatar == false) {
                            api.openWin({
                                name: 'sign-edit',
                                url: './html/sign-edit.html',
                                slidBackEnabled: false,
                                bgColor: '#fff',
                                delay: 200,
                                pageParam: {
                                    nickName: ret1.data.nickName
                                }
                            });
                        }
                    }
                });
            }
        });
    }

    function relogin(ckeck) {

        var password = isEmpty($api.getStorage('password')) ? '' : $.trim($api.getStorage('password'));
        var account = isEmpty($api.getStorage('account')) ? '' : $.trim($api.getStorage('account'));

        if (password && account) {
            if (!ckeck) {
                DoLogin(account, password);
            }
            clearInterval(reloginTimer);
            reloginTimer = setInterval(function() {
                DoLogin(account, password);
            }, 20 * 60 * 1000);
        }

    }
    var is_resume;
    apiready = function() {      


        var tasksProgress = {
            categoryId: 'ff808081473905e701475cd3c2080001', // 证书id
            categoryName: 'testTasksProgress',
            subjectId: 'ff808081473905e701476204cb6c006f', // 科目id
            subjectName: 'testTasksProgress',
            courseId: 'ff8080814dad5062014db32051b801a2', // 课程id
            courseName: 'testTasksProgress', // 课程名称
            chapterId: 'ff8080814dad5062014db320524e01c0', // 章节id
            chapterName: 'testTasksProgress', //章节名称
            taskId: 'ff8080814dad5062014db320525401c1', // 任务id
            taskName: 'testTasksProgress', //任务名称
            progress: "1111", // 最后1次学习进度
            total: "2493", // 任务总长度
            state: 'init', // 是否播放结束
            downloadProgress: '', // 下载进度
            downloadState: '', // 下载状态（ing，stop，end）
            downloadDate: '', // 下载日期
            expiredDate: '' // 过期日期
        }

        // DB.saveTasksProgress(tasksProgress,function(ret, err){
        // 	// DB.showTasksProgress();
        // });
        // DB.delTasksProgress();
         //DB.clearTasksProgress();
        DB.showTasksProgress();
        // DB.getTaskProgressSync('ff8080814dc1dc4e014e00cca76a2e0b');
        // DB.getCourseIdAll(function(data){
        // 	alert(JSON.stringify(data));
        // })
        // DB.getTaskProgress('2',function(data){
        // 	alert(data);
        // })
        // DB.getTaskProgressNoSend(function(data){
        // 	alert('nosend:::'+JSON.stringify(data));
        // })

        is_resume = false;
        api.setKeepScreenOn({
            keepOn: true
        });
        //初始话视频
        if (api.systemType == 'android') {
            if (cache_model == null) {
                cache_model = api.require('lbbVideo');
                cache_model.initDownload({"userId":getstor('memberId')});
                cache_model.init();
            }
        }
        if (api.systemType == 'ios') {
            if (cache_model == null) {
                cache_model = api.require('lbbVideo');
                cache_model.downloadCourseTabel();
                cache_model.initDownload({"userId":getstor('memberId')});
            }
        }
        //应用进入后台事件
        api.addEventListener({
            name: 'pause'
        }, function(ret, err) {
            saveTasksProgress.init();
            api.sendEvent({
                name: "lbbpause"
            });
            
            is_resume = true;
            var memberId = getstor('memberId');
            if (memberId && api.systemType == 'ios') {
//              var downed = isEmpty($api.getStorage(memberId + 'downed')) ? '' : $api.getStorage(memberId + 'downed');
//              if (downed) {
//                  $api.setStorage(memberId + 'backendDowned', downed);
//                  $api.rmStorage(memberId + 'downed');
//                  var chapterIdA = downed['chapterIdA'];
//                  var chapterIdB = downed['chapterIdB'];
//                  var chapterIdC = downed['chapterIdC'];
//                  if (cache_model == null) {
//                      cache_model = api.require('lbbVideo');
//                  }
              
//                  cache_model.downloadStop({"userId":memberId},function(ret, err) {
//
//                      set_down({
//                          type: 1,
//                          chapterida: chapterIdA,
//                          chapteridb: chapterIdB,
//                          chapteridc: chapterIdC
//                      });
//                      api.sendEvent({
//                          name: 'flush_cache'
//                      });
//                  });
//              }
            }
        });
        //应用从后台回到前台事件
        api.addEventListener({
            name: 'resume'
        }, function(ret, err) {
            saveTasksProgress.init();
            api.sendEvent({
                name: "lbbresume"
            });
            if (is_resume) {
                var jsfun = "relogin();";
                api.execScript({
                    name: 'root',
                    script: jsfun
                });
            }
            if (api.systemType == 'ios') {
//              cachemodel = api.require('lbbVideo');
//              cachemodel.init();
//              var memberId = getstor('memberId');
//              if (memberId && api.systemType == 'ios') {
//                  var downed = isEmpty($api.getStorage(memberId + 'backendDowned')) ? '' : $api.getStorage(memberId + 'backendDowned');
//                  if (downed) {
//                      $api.rmStorage(memberId + 'backendDowned');
//                      downed['type'] = 2;
//                      mydown(downed);
//                  }
//              }
            }
        });
        var memberId = getstor('memberId');
        if (memberId) {
            var downed = isEmpty($api.getStorage(memberId + 'downed')) ? '' : $api.getStorage(memberId + 'downed');
            if (downed) {
                $api.rmStorage(memberId + 'downed');
                var chapterIdA = downed['chapterIdA'];
                var chapterIdB = downed['chapterIdB'];
                var chapterIdC = downed['chapterIdC'];
                if (cache_model == null) {
                    cache_model = api.require('lbbVideo');
                }
                cache_model.downloadStop({"userId":memberId},function(ret, err) {

                    set_down({
                        type: 1,
                        chapterida: chapterIdA,
                        chapteridb: chapterIdB,
                        chapteridc: chapterIdC
                    });
                    api.sendEvent({
                        name: 'flush_cache'
                    });
                });
            }
        }
        //网络断开监听  网络已断开
        api.addEventListener({
            name: 'offline'
        }, function(ret, err) {
            window.shut_network = true;
            window.allow_down = false;

            var memberId = getstor('memberId');
            //是否在播放页面
            //保存进度
            var downed = $api.getStorage(memberId + 'downed');
            if (downed) {
                $api.rmStorage(memberId + 'downed');
                var chapterIdA = downed['chapterIdA'];
                var chapterIdB = downed['chapterIdB'];
                var chapterIdC = downed['chapterIdC'];

                if (cache_model == null) {
                    cache_model = api.require('lbbVideo');
                }
                if (api.connectionType == 'unknown' || api.connectionType == 'none') {

                    cache_model.downloadStop({"userId":memberId},function(ret, err) {

                        set_down({
                            type: 'shut_network',
                            chapterida: chapterIdA,
                            chapteridb: chapterIdB,
                            chapteridc: chapterIdC
                        });
                        api.sendEvent({
                            name: 'flush_cache'
                        });
                    });
                } else if (api.connectionType == '2g' || api.connectionType == '3g' || api.connectionType == '4g' || api.connectionType == '2G' || api.connectionType == '3G' || api.connectionType == '4G') {
                    window.shut_network = false;
                    cache_model.downloadStop({"userId":memberId},function(ret, err) {

                        set_down({
                            type: 'not_wifi',
                            chapterida: chapterIdA,
                            chapteridb: chapterIdB,
                            chapteridc: chapterIdC
                        });
                        api.sendEvent({
                            name: 'flush_cache'
                        });
                    });
                }
            }
        });
        //网络类型判断
        api.addEventListener({
            name: 'online'
        }, function(ret, err) {
            saveTasksProgress.init();
            //保存进度
            window.shut_network = false;
            var connectionType = ret.connectionType;
            if (connectionType == 'wifi') {
                window.allow_down = true;
            } else {
                window.allow_down = false;
                var memberId = getstor('memberId');
                var downed = $api.getStorage(memberId + 'downed');
                if (downed) {
                    var chapterIdA = downed['chapterIdA'];
                    var chapterIdB = downed['chapterIdB'];
                    var chapterIdC = downed['chapterIdC'];
                    $api.rmStorage(memberId + 'downed');
                    if (cache_model == null) {
                        cache_model = api.require('lbbVideo');
                    }
                    cache_model.downloadStop({"userId":memberId},function(ret, err) {

                        set_down({
                            type: 'not_wifi',
                            chapterida: chapterIdA,
                            chapteridb: chapterIdB,
                            chapteridc: chapterIdC
                        });
                        api.sendEvent({
                            name: 'flush_cache'
                        });
                    });
                }
            }
        });
        window.localStorage.systemType = api.systemType + parseInt(api.systemVersion);
        //学习提醒推送
        var header = document.querySelector('.header');
        $api.fixIos7Bar(header);
        api.setStatusBarStyle({
            style: 'dark'
        });
        if (!isEmpty(api.pageParam.to_ucenter)) {
            to_ucenter(true);
        }
        my_init(function(ret) {
            if (ret) { //token可继续登录
                $api.setStorage('mine', ret);
                if (ret.isAvatar == false) {
                    api.openWin({
                        name: 'sign-edit',
                        url: './html/sign-edit.html',
                        slidBackEnabled: false,
                        bgColor: '#fff',
                        delay: 200
                    });
                    return false;
                } else {
                    to_ucenter(true);
                    return false;
                }
            } else { //token不能登录了
                var outh = isEmpty($api.getStorage('outh')) ? '' : $api.getStorage('outh');
                if (outh) {
                    $api.rmStorage('password');
                    set_token(function(res, errors) {
                        if (res && res.state == 'success') {
                            //继续登录
                            outh['token'] = res.data.token;
                            $api.setStorage('token', res.data.token);
                            ajaxRequest('api/v2.1/oauthLogin', 'post', outh, function(ret, err) { //007.003 auth登录
                                api.removeLaunchView({
                                    animation: {
                                        type: 'fade',
                                        duration: 500
                                    }
                                });
                                if (ret && ret.state == 'success') {
                                    $api.setStorage('token', ret.data.token);
                                    $api.setStorage('mine', ret.data);
                                    $api.setStorage('outh', {
                                        'societyType': outh.societyType,
                                        'societyId': outh.societyId
                                    });
                                    if (ret.data.isAvatar == false) {
                                        api.openWin({
                                            name: 'sign-edit',
                                            url: './html/sign-edit.html',
                                            slidBackEnabled: false,
                                            bgColor: '#fff',
                                            delay: 200,
                                            pageParam: {
                                                nickName: ret.data.nickName
                                            }
                                        });
                                        return false;
                                    } else {
                                        to_ucenter(true);
                                        return false;
                                    }
                                } else if (ret.state == 'error') {
                                    if (ret.msg == '1001') {
                                        $api.setStorage('outh', {
                                            'societyType': outh.societyType,
                                            'societyId': outh.societyId
                                        });
                                        to_bind();
                                        return false;
                                    }
                                }
                            });
                        }
                    });
                }
                var password = isEmpty($api.getStorage('password')) ? '' : $.trim($api.getStorage('password'));
                var account = isEmpty($api.getStorage('account')) ? '' : $.trim($api.getStorage('account'));
                if (password && account) { //如果记住了帐号和密码
                    if (!is_resume) {
                        set_token(function(res, errors) {
                            if (res && res.state == 'success') {
                                //继续登录
                                var param = {};
                                param.account = account;
                                param.password = password;
                                param.token = res.data.token;
                                ajaxRequest('api/v2.1/login', 'post', param, function(ret, err) { //007.005 会员登录
                                    if (ret && ret.state == 'success') {

                                        $api.setStorage('account', account);
                                        $api.setStorage('password', password);

                                        $api.setStorage('token', ret.data.token);
                                        $api.setStorage('mine', ret.data);
                                        if (ret.data.isAvatar == false) {
                                            api.openWin({
                                                name: 'sign-edit',
                                                url: './html/sign-edit.html',
                                                slidBackEnabled: false,
                                                bgColor: '#fff',
                                                delay: 200,
                                                pageParam: {
                                                    nickName: ret.data.nickName
                                                }
                                            });
                                            return false;
                                        } else {
                                            to_ucenter(true);
                                            return false;
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
                $('input[name=username]').val(account);
                $('input[name=password]').val(password);
                to_login();
            }
        });
        var appBundle;
        if (api.systemType == 'ios') {
            var obj = api.require('qq');
            obj.installed(function(ret, err) {
                if (!ret.status) {
                    $('.login_qq').remove();
                }
            });
            appBundle = 'wechat://';
            app_installed(appBundle, function(ret) {
                if (!ret) {
                    $('.login_wx').remove();
                }
            });
            appBundle = "sinaweibo://";
            app_installed(appBundle, function(ret) {
                if (!ret) {
                    $('.login_wb').remove();
                }
            });
        }
        api.addEventListener({
            name: 'to_login'
        }, function(res, err) {
            if (res.value.out == true) {

                ajaxRequest('api/v2.1/logout', 'get', {
                    token: $api.getStorage('token')
                }, function(ret, err) { //007.010 会员退出
                });

                $api.rmStorage('token');
                $api.rmStorage('password');
            }
            $api.rmStorage('mine');
            $api.rmStorage('outh');

            $api.rmStorage('notice_time');
            $api.rmStorage('open_notice');
            $api.rmStorage('center_num');
            var memberId = getstor('memberId');
            $api.rmStorage(memberId + 'scale/browsers');
            $api.rmStorage(memberId + 'learning/lines');
            $api.rmStorage(memberId + 'learningcourse');
            $api.rmStorage(memberId + 'capabilityAssessment');
            // $api.clearStorage();
            to_login();

        });
        //打开在学课程监听
        api.addEventListener({
            name: 'to_stuyding'
        }, function(ret, err) {
            api.closeFrameGroup({
                name: 'course_tab'
            });
            openTabMe(1);
            set_index(0);
        });
        //消息数量监听
        api.addEventListener({
            name: 'course_num'
        }, function(ret) {
            if (ret && ret.value) {
                var value = ret.value;
                if (value < 1) {
                    $('.msg-mark').html('');
                } else {
                    $('.msg-mark').html(value.num);
                }
            }
        });
        //打开待激活课程监听
        api.addEventListener({
            name: 'wjhkc'
        }, function(ret, err) {
            openTabMe(1);
            set_index(1);
        });
        api.addEventListener({
            name: 'keyback'
        }, function(ret, err) {
            clearTimeout(timePicker);
            //coding... auth:yx
            if (clickCount != 2) {
                api.toast({
                    msg: '再按一次返回系统桌面'
                }, 'middle');
                clickCount++;
                timePicker = setTimeout(function() {
                    clickCount = 1;
                }, 1000);
            } else {
                clickCount = 1;
                api.toLauncher();
            }
        });
        commonFun.adjustHeight(0.077);
        //已读消息更新接听
        api.addEventListener({
            name: 'center_num'
        }, function(ret) {
            if (!isEmpty($api.getStorage('center_num') && $api.getStorage('center_num') != 0)) {
                var num = $api.getStorage('center_num');
                if (num > 99) {
                    $('.center_num').html('99+');
                } else if (num < 1) {
                    $('.center_num').html(num);
                } else {
                    $('.center_num').html('');
                }
            }
        });

        var param = {};
        param.pageNo = 0;
        param.pageSize = 1;
        param.typeId = '';
        param.isRead = 0;
        param.type = 1;
        param.token = $api.getStorage('token');
        ajaxRequest('api/v2/message/list', 'get', param, function(ret, err) {
            
            if (err) {
                api.toast({
                    msg : err.msg,
                    location : 'middle'
                });
                return false;
            }
            if (ret && ret.state == 'success') {
                if (ret.totalCount == 0) {
                    $('.message-bells .msg-mark').addClass('none');
                } else {
                	if(ret.totalCount > 99){
                		$('.message-bells .msg-mark').html("99+");
                	}else{
                		$('.message-bells .msg-mark').html(ret.totalCount);
                	}
                    
                }
                $api.setStorage('center_num', ret.totalCount);
            } else {
                //api.toast({
                //  msg : ret.msg,
                //  location : 'middle'
                //});
            }
        });
 
        
//已读消息更新接听
    api.addEventListener({
        name : 'center_num'
    }, function(ret) {
        if ($api.getStorage('center_num') && $api.getStorage('center_num') != 0) {
            var num = $api.getStorage('center_num');
            if(num > 99){
        		$('.message-bells .msg-mark').html("99+");
        	}else{
        		$('.message-bells .msg-mark').html(num);
        	}
            $('.center_num').removeClass('none');
        } else {
            $('.message-bells .msg-mark').addClass('none');
            $('.center_num').addClass('none');
        }

    });
    };
    </script>
</body>

</html>
